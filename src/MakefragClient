OBJDIRS += client_shared

ifeq ($(INFINIBAND),yes)
INFINIBAND_SRCFILES := \
	   src/Infiniband.cc \
	   src/InfRcTransport.cc \
	   src/InfUdDriver.cc \
	   $(NULL)
else
INFINIBAND_SRCFILES :=
endif

CLIENT_SRCFILES := \
		   src/BenchUtil.cc \
		   src/Buffer.cc \
		   src/CRamCloud.cc \
		   src/Client.cc \
		   src/ClientException.cc \
		   src/CoordinatorClient.cc \
		   src/Crc32C.cc \
		   src/Common.cc \
		   src/Dispatch.cc \
		   src/Driver.cc \
		   src/FailureDetector.cc \
		   src/FastTransport.cc \
		   src/IpAddress.cc \
		   src/Logging.cc \
		   src/MasterClient.cc \
		   src/Metrics.cc \
		   src/ObjectFinder.cc \
		   src/OptionParser.cc \
		   src/RamCloud.cc \
		   src/ServiceLocator.cc \
		   src/Status.cc \
		   src/TcpTransport.cc \
		   src/TimeCounter.cc \
		   src/TransportManager.cc \
		   src/UdpDriver.cc \
		   $(INFINIBAND_SRCFILES) \
		   $(OBJDIR)/ServerList.pb.cc \
		   $(OBJDIR)/Tablets.pb.cc \
		   $(NULL)

CLIENT_OBJFILES := $(CLIENT_SRCFILES)
CLIENT_OBJFILES := $(patsubst src/%.cc, $(OBJDIR)/%.o, $(CLIENT_OBJFILES))
CLIENT_OBJFILES := $(patsubst $(OBJDIR)/%.cc, $(OBJDIR)/%.o, $(CLIENT_OBJFILES))

CLIENT_SHARED_OBJFILES := $(CLIENT_SRCFILES)
CLIENT_SHARED_OBJFILES := $(patsubst src/%.cc, $(OBJDIR)/client_shared/%.o, $(CLIENT_SHARED_OBJFILES))
CLIENT_SHARED_OBJFILES := $(patsubst $(OBJDIR)/%.cc, $(OBJDIR)/client_shared/%.o, $(CLIENT_SHARED_OBJFILES))

$(OBJDIR)/client_shared/%.o: $(TOP)/src/%.cc $(AUTO_GEN_HEADERS)
	@mkdir -p $(@D)
	$(call run-cxx,$@,$<,-fPIC)

$(OBJDIR)/client_shared/%.o: $(OBJDIR)/%.cc $(AUTO_GEN_HEADERS)
	@mkdir -p $(@D)
	$(call run-cxx,$@,$<,-fPIC)

$(OBJDIR)/libramcloud.a: $(CLIENT_OBJFILES)
	@mkdir -p $(@D)
	$(AR) rcs $@ $^

# protocol buffers seems to need -lpthread, meh
$(OBJDIR)/libramcloud.so: $(CLIENT_SHARED_OBJFILES)
	@mkdir -p $(@D)
	$(CXX) -shared $(LIBS) -lpthread -o $@ $^ -Wl,--no-undefined

$(OBJDIR)/client: $(OBJDIR)/RamCloudMain.o $(OBJDIR)/libramcloud.a
	@mkdir -p $(@D)
	$(CXX) $(CXXFLAGS) -o $@ $< -L$(OBJDIR) $(OBJDIR)/libramcloud.a

$(OBJDIR)/ensureHosts: $(OBJDIR)/EnsureHosts.o $(OBJDIR)/libramcloud.a
	@mkdir -p $(@D)
	$(CXX) $(CXXFLAGS) -o $@ $< -L$(OBJDIR) $(OBJDIR)/libramcloud.a

.PHONY: client client-lib client-lib-static client-lib-shared client-lib-install client-lib-uninstall ensureHosts

client-lib-static: $(OBJDIR)/libramcloud.a
client-lib-shared: $(OBJDIR)/libramcloud.so
client-lib: client-lib-static client-lib-shared

# TODO(stutsman) need to rethink includes because right now this requires
# -lramcloud -I/usr/local/include/ramcloud
CLIENT_LIB_INSTALL_PREFIX := /usr/local
client-lib-install:
	-mkdir -p $(CLIENT_LIB_INSTALL_PREFIX)/lib
	install -m 644 $(OBJDIR)/libramcloud.a $(CLIENT_LIB_INSTALL_PREFIX)/lib
	install -m 644 $(OBJDIR)/libramcloud.so $(CLIENT_LIB_INSTALL_PREFIX)/lib
	-mkdir -p $(CLIENT_LIB_INSTALL_PREFIX)/include/ramcloud
	install -m 644 $(TOP)/src/RamCloudClient.h $(CLIENT_LIB_INSTALL_PREFIX)/include/ramcloud
	-mkdir -p $(CLIENT_LIB_INSTALL_PREFIX)/include/ramcloud
	install -m 644 $(TOP)/src/Net.h $(CLIENT_LIB_INSTALL_PREFIX)/include/ramcloud
	install -m 644 $(TOP)/src/net_user.h $(CLIENT_LIB_INSTALL_PREFIX)/include/ramcloud
	install -m 644 $(TOP)/src/net_udp.h $(CLIENT_LIB_INSTALL_PREFIX)/include/ramcloud
	install -m 644 $(TOP)/src/net_tcp.h $(CLIENT_LIB_INSTALL_PREFIX)/include/ramcloud
	install -m 644 $(TOP)/src/rcrpc.h $(CLIENT_LIB_INSTALL_PREFIX)/include/ramcloud

client-lib-uninstall:
	rm -rfv $(CLIENT_LIB_INSTALL_PREFIX){/lib/libramcloud*,/include/ramcloud}

client: $(OBJDIR)/client $(OBJDIR)/ensureHosts $(OBJDIR)/libramcloud.a $(OBJDIR)/libramcloud.so

all: client
