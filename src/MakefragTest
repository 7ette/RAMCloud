OBJDIRS += tests

TESTS_SRCFILES := \
		src/ServerTest.cc \
		src/BackupServerTest.cc \
		src/BackupClientTest.cc \
		src/BitmapTest.cc \
		src/BufferTest.cc \
		src/ServiceTest.cc \
		src/HashTableTest.cc \
		src/ChecksumTest.cc \
		src/SegmentTest.cc \
		src/LogTest.cc \
		src/TCPTransportTest.cc \
		src/TestRunner.cc

TESTS_OBJFILES := $(TESTS_SRCFILES)
TESTS_OBJFILES := $(patsubst src/%.cc, $(OBJDIR)/%.o, $(TESTS_OBJFILES))
TESTS_OBJFILES := $(patsubst src/%.cc, $(OBJDIR)/%.o, $(TESTS_OBJFILES))
TESTS_OBJFILES := $(TESTS_OBJFILES) \
               $(SHARED_OBJFILES) \
               $(SERVER_OBJFILES) \
               $(BACKUP_OBJFILES)

TESTS_LIB := -lcppunit -ldl -lpthread -lgtest -lgmock

$(TOP)/src/TCPTransportTest.cc: $(TOP)/src/TCPTransportTestMock.py $(TOP)/src/TCPTransportTest.in.cc
	$(TOP)/src/TCPTransportTestMock.py $@ < $(TOP)/src/TCPTransportTest.in.cc

$(OBJDIR)/test: $(TESTS_OBJFILES)
	@mkdir -p $(@D)
	$(CXX) $(TESTS_LIB) -o $@ $^

# TODO(ongaro) The unit tests don't actually call HashTableBenchmark, Echo, or
# Telnet. I just wanted to make sure it continues to build over time.
test: $(OBJDIR)/test $(OBJDIR)/HashTableBenchmark $(OBJDIR)/Echo $(OBJDIR)/Telnet
	$(OBJDIR)/test

$(OBJDIR)/HashTableBenchmark: $(OBJDIR)/HashTableBenchmark.o $(SHARED_OBJFILES) $(SERVER_OBJFILES)
	@mkdir -p $(@D)
	$(CXX) -o $@ $^

$(OBJDIR)/Echo: $(OBJDIR)/Echo.o $(SHARED_OBJFILES) $(SERVER_OBJFILES)
	@mkdir -p $(@D)
	$(CXX) -o $@ $^

$(OBJDIR)/Telnet: $(OBJDIR)/Telnet.o $(SHARED_OBJFILES) $(SERVER_OBJFILES)
	@mkdir -p $(@D)
	$(CXX) -o $@ $^

tests-clean:
	rm -f $(TOP)/src/TCPTransportTest.cc
